<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Club Commander</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // ================= FIREBASE SETUP =================
    const firebaseConfig = {
        apiKey: "AIzaSyAzqziHOSsLCYmKCMhgI-5fWyL-_HJJlrU",
        authDomain: "club-commander-1eac1.firebaseapp.com",
        databaseURL: "https://club-commander-1eac1-default-rtdb.firebaseio.com",
        projectId: "club-commander-1eac1",
        storageBucket: "club-commander-1eac1.firebasestorage.app",
        messagingSenderId: "503757527515",
        appId: "1:503757527515:web:ff9a09abd89d0d283f2ffe"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
</script>
    <style>
        .ai-float {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .ai-float:hover {
            transform: scale(1.1);
        }
        .ai-chat {
            display: none;
            position: fixed;
            bottom: 5.5rem;
            right: 1.5rem;
            width: 20rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        .ai-chat.active {
            display: block;
        }
        .sidebar {
            transition: all 0.3s;
        }
        .event-item, .team-item, .member-item, .task-item {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }
        .event-item:hover, .team-item:hover, .member-item:hover, .task-item:hover {
            background: #f3f4f6;
        }
        select, input, textarea, button {
            transition: all 0.2s;
        }
        button:hover:not(.bg-gray-300):not(.bg-gray-200):not(.bg-gray-500) {
            background: #2563eb;
        }
        #quick-custom-due-fields, #modal-custom-due-fields, #edit-custom-due-fields {
            display: none;
        }
        dialog {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            width: 32rem;
            max-width: 90%;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }
        .task-modal .space-y-4 > div, .history-modal .space-y-4 > div, .edit-modal .space-y-4 > div, .quick-task-modal .space-y-4 > div, .pending-modal .space-y-4 > div, .leaderboard-modal .space-y-4 > div {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .overdue-task {
            border-left: 4px solid #ef4444;
        }
        .button-group {
            position: relative;
            display: inline-block;
        }
        .button-group .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.25rem;
        }
        .button-group .dropdown-content button {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
        }
        .button-group .dropdown-content button:hover {
            background-color: #e5e7eb;
        }
        .button-group:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">
        <header class="bg-white p-4 text-center shadow relative">
        <h1 class="text-2xl font-bold">üèÜ Club Commander</h1>
        <p class="text-gray-600">Event Manager</p>
         <div id="auth-section" class="absolute top-4 right-4">
            <div id="logged-out" class="hidden">
                <input type="email" id="email" placeholder="Email" class="border p-1 rounded text-sm" style="width: 120px;">
                <input type="password" id="password" placeholder="Password" class="border p-1 rounded text-sm ml-1" style="width: 120px;">
                <button onclick="login()" class="bg-green-500 text-white px-2 py-1 rounded text-sm ml-1">Login</button>
                <button onclick="register()" class="bg-blue-500 text-white px-2 py-1 rounded text-sm ml-1">Register</button>
            </div>
            
            <div id="logged-in" class="hidden">
                <span id="user-email" class="mr-2 text-sm"></span>
                <button onclick="openProfile()" class="bg-purple-500 text-white px-2 py-1 rounded text-sm">Profile</button>
                <button onclick="logout()" class="bg-red-500 text-white px-2 py-1 rounded text-sm ml-1">Logout</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="sidebar w-64 bg-gray-200 p-4 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-2">Events</h3>
            <ul id="event-list" class="space-y-2"></ul>
            <button id="new-event" class="mt-2 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">+ New Event</button>
        </div>

        <div class="main flex-1 p-4 overflow-y-auto">
            <div id="event-details" class="hidden">
                <h3 class="text-lg font-semibold mb-2" id="event-title"></h3>
                
                <div id="overdue-notification" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <p>Overdue tasks detected: <span id="overdue-tasks"></span></p>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button id="open-quick-task-modal" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">‚ö° Quick Assign</button>
                    <button id="open-pending-modal" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">üìã Pending Tasks</button>
                    <button id="open-leaderboard-modal" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">üèÜ Leaderboard</button>
                </div>

                <h4 class="text-md font-medium mt-4 mb-2">Teams & Members for this Event</h4>
                <button id="new-team" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-4">+ New Team</button>
                <ul id="team-list" class="team-list space-y-2"></ul>

                <div id="selected-team-members" class="hidden mt-6">
                    <h4 class="text-md font-medium mb-2" id="selected-team-title"></h4>
                    <select id="team-member-dropdown" class="mt-1 block w-full border rounded p-2 mb-4"></select>
                    <button onclick="openTaskModalFromDropdown()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Assign Task to Selected Member</button>
                    <ul id="selected-members-list" class="space-y-2 mt-4"></ul>
                </div>
            </div>

            <div id="no-event-selected" class="text-center text-gray-600">
                <h3 class="text-lg font-semibold">Select an Event</h3>
                <p>Select an event from the sidebar to get started. Or create a new event to begin managing your club tasks.</p>
            </div>
        </div>

        <div class="ai-float" id="ai-toggle">ü§ñ</div>
        <div class="ai-chat" id="ai-chat">
            <h3 class="text-lg font-semibold mb-2">ü§ñ AI Assistant</h3>
            <p class="text-gray-600 mb-2">Get smart suggestions for this event</p>
            <div class="mb-2">
                <input id="ask-ai" type="text" class="w-full border rounded p-2" placeholder="Ask AI" />
                <button id="send-ai" class="mt-2 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Send</button>
            </div>
            <p class="mb-2">AI Suggestion: <span id="ai-suggestion"></span></p>
            <div class="space-y-2">
                <button id="suggest-assignments" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">Suggest Assignments</button>
                <button id="check-deadlines" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">Check Deadlines</button>
                <button id="view-history" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">View Member Performance</button>
            </div>
        </div>
    </div>

    <!-- Quick Task Assignment Modal -->
    <dialog id="quick-task-modal" class="quick-task-modal">
        <h3 class="text-lg font-semibold mb-4">‚ö° Quick Task Assignment</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Team:</label>
                <select id="quick-team" class="mt-1 block w-full border rounded p-2" onchange="updateQuickMembers()"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Assign to:</label>
                <select id="quick-member" class="mt-1 block w-full border rounded p-2"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Task:</label>
                <input id="quick-task" type="text" class="mt-1 block w-full border rounded p-2" placeholder="e.g., Prepare banners" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description (optional):</label>
                <textarea id="quick-description" class="mt-1 block w-full border rounded p-2" rows="3" placeholder="e.g., Design and print 10 banners"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Category:</label>
                <select id="quick-category" class="mt-1 block w-full border rounded p-2">
                    <option>General</option>
                    <option>Logistics</option>
                    <option>Marketing</option>
                    <option>Setup</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Priority:</label>
                <select id="quick-priority" class="mt-1 block w-full border rounded p-2">
                    <option>Normal</option>
                    <option>High</option>
                    <option>Urgent</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Due Time:</label>
                <select id="quick-due" class="mt-1 block w-full border rounded p-2" onchange="toggleQuickCustomDue()">
                    <option>1 hour</option>
                    <option>3 hours</option>
                    <option>Today EOD</option>
                    <option>Tomorrow</option>
                    <option>This week</option>
                    <option>Custom</option>
                    <option>No Deadline</option>
                </select>
            </div>
            <div id="quick-custom-due-fields" class="space-y-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Date:</label>
                    <input id="quick-custom-date" type="date" class="mt-1 block w-full border rounded p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Time:</label>
                    <input id="quick-custom-time" type="time" class="mt-1 block w-full border rounded p-2" />
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeQuickTaskModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Cancel</button>
                <button id="quick-assign" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Assign</button>
            </div>
        </div>
    </dialog>
    <!-- ADD PROFILE MODAL -->
    <dialog id="profile-modal">
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">User Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Display Name:</label>
                    <input type="text" id="profile-name" class="border rounded p-2 w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium">Phone:</label>
                    <input type="tel" id="profile-phone" class="border rounded p-2 w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium">Role in Club:</label>
                    <select id="profile-role" class="border rounded p-2 w-full">
                        <option>Member</option>
                        <option>Team Lead</option>
                        <option>Event Manager</option>
                        <option>Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Bio:</label>
                    <textarea id="profile-bio" class="border rounded p-2 w-full" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeProfile()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
                    <button onclick="saveProfile()" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Pending Tasks Modal -->
    <dialog id="pending-modal" class="pending-modal">
        <h3 class="text-lg font-semibold mb-4">üìã Pending Tasks</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                <select id="pending-task-filter" class="mt-1 block w-full border rounded p-2" onchange="renderPendingTasksModal()">
                    <option value="">All Categories</option>
                    <option>General</option>
                    <option>Logistics</option>
                    <option>Marketing</option>
                    <option>Setup</option>
                    <option>Other</option>
                </select>
            </div>
            <ul id="pending-task-list" class="space-y-2"></ul>
            <div class="flex justify-end">
                <button onclick="closePendingModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Close</button>
            </div>
        </div>
    </dialog>

    <!-- Leaderboard Modal -->
    <dialog id="leaderboard-modal" class="leaderboard-modal">
        <h3 class="text-lg font-semibold mb-4">üèÜ Leaderboard</h3>
        <div class="space-y-4">
            <ul id="leaderboard-list" class="space-y-2"></ul>
            <div class="flex justify-end">
                <button onclick="closeLeaderboardModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Close</button>
            </div>
        </div>
    </dialog>

    <!-- Task Assignment Modal -->
    <dialog id="task-modal" class="task-modal">
        <h3 class="text-lg font-semibold mb-4">Assign Task to <span id="modal-member-name"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Task:</label>
                <input id="modal-task" type="text" class="mt-1 block w-full border rounded p-2" placeholder="e.g., Prepare banners" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description (optional):</label>
                <textarea id="modal-description" class="mt-1 block w-full border rounded p-2" rows="3" placeholder="e.g., Design and print 10 banners"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Category:</label>
                <select id="modal-category" class="mt-1 block w-full border rounded p-2">
                    <option>General</option>
                    <option>Logistics</option>
                    <option>Marketing</option>
                    <option>Setup</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Priority:</label>
                <select id="modal-priority" class="mt-1 block w-full border rounded p-2">
                    <option>Normal</option>
                    <option>High</option>
                    <option>Urgent</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Due Time:</label>
                <select id="modal-due" class="mt-1 block w-full border rounded p-2" onchange="toggleModalCustomDue()">
                    <option>1 hour</option>
                    <option>3 hours</option>
                    <option>Today EOD</option>
                    <option>Tomorrow</option>
                    <option>This week</option>
                    <option>Custom</option>
                    <option>No Deadline</option>
                </select>
            </div>
            <div id="modal-custom-due-fields" class="space-y-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Date:</label>
                    <input id="modal-custom-date" type="date" class="mt-1 block w-full border rounded p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Time:</label>
                    <input id="modal-custom-time" type="time" class="mt-1 block w-full border rounded p-2" />
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeTaskModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Cancel</button>
                <button id="modal-assign" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Assign</button>
            </div>
        </div>
    </dialog>

    <!-- Task Edit Modal -->
    <dialog id="edit-task-modal" class="edit-modal">
        <h3 class="text-lg font-semibold mb-4">Edit Task for <span id="edit-member-name"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Task:</label>
                <input id="edit-task" type="text" class="mt-1 block w-full border rounded p-2" placeholder="e.g., Prepare banners" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description (optional):</label>
                <textarea id="edit-description" class="mt-1 block w-full border rounded p-2" rows="3" placeholder="e.g., Design and print 10 banners"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Category:</label>
                <select id="edit-category" class="mt-1 block w-full border rounded p-2">
                    <option>General</option>
                    <option>Logistics</option>
                    <option>Marketing</option>
                    <option>Setup</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Priority:</label>
                <select id="edit-priority" class="mt-1 block w-full border rounded p-2">
                    <option>Normal</option>
                    <option>High</option>
                    <option>Urgent</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Due Time:</label>
                <select id="edit-due" class="mt-1 block w-full border rounded p-2" onchange="toggleEditCustomDue()">
                    <option>1 hour</option>
                    <option>3 hours</option>
                    <option>Today EOD</option>
                    <option>Tomorrow</option>
                    <option>This week</option>
                    <option>Custom</option>
                    <option>No Deadline</option>
                </select>
            </div>
            <div id="edit-custom-due-fields" class="space-y-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Date:</label>
                    <input id="edit-custom-date" type="date" class="mt-1 block w-full border rounded p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Custom Time:</label>
                    <input id="edit-custom-time" type="time" class="mt-1 block w-full border rounded p-2" />
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Remarks (optional):</label>
                <textarea id="edit-remarks" class="mt-1 block w-full border rounded p-2" rows="3" placeholder="e.g., Task completed successfully"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditTaskModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Cancel</button>
                <button id="edit-save" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Save</button>
            </div>
        </div>
    </dialog>

    <!-- Work History Modal -->
    <dialog id="history-modal" class="history-modal">
        <h3 class="text-lg font-semibold mb-4">Work History for <span id="history-member-name"></span></h3>
        <div class="space-y-4">
            <p>Total Points: <span id="history-member-points" class="font-medium"></span></p>
            <ul id="history-task-list" class="space-y-2"></ul>
            <div class="flex justify-end">
                <button onclick="closeHistoryModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">Close</button>
            </div>
        </div>
    </dialog>

    <script>
        // Local storage key
        const STORAGE_EVENTS = 'club_events';

        // Load data from local storage
        let events = JSON.parse(localStorage.getItem(STORAGE_EVENTS)) || [];
        let currentEvent = null;
        let selectedTeam = null;
        let currentAssignMember = null;
        let currentAssignTeam = null;
        let currentEditMember = null;
        let currentEditTeam = null;
        let currentEditTaskIndex = null;
        let currentEditTaskStatus = null;
        
        // ADD FIREBASE VARIABLES
        let currentUserProfile = null;
        let currentUserId = null;

                // Function to save data
        async function saveData() {
            // First save to localStorage as backup
            try {
                localStorage.setItem(STORAGE_EVENTS, JSON.stringify(events));
            } catch (e) {
                console.error('Local storage save error:', e);
            }
            
            // Save to Firebase if user is logged in
            if (currentUserId) {
                try {
                    await db.ref('users/' + currentUserId + '/events').set(events);
                    console.log('Data saved to Realtime Database');
                } catch (error) {
                    console.error('Realtime DB save error:', error);
                    alert('Error saving to cloud: ' + error.message);
                }
            }
        }

        // Format timestamp for display
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            } catch (e) {
                console.error('Timestamp format error:', e);
                return 'Invalid timestamp';
            }
        }

        // Calculate points for a task
        function calculateTaskPoints(task) {
            let basePoints = 0;
            if (task.priority === 'Normal') basePoints = 5;
            else if (task.priority === 'High') basePoints = 10;
            else if (task.priority === 'Urgent') basePoints = 15;
            if (task.status === 'Completed') {
                const timing = calculateTaskTiming(task.due, task.createdAt, task.completedAt);
                if (timing === 'Early') {
                    return basePoints + (task.priority === 'Normal' ? 2 : task.priority === 'High' ? 3 : 5);
                } else if (timing === 'Late') {
                    return Math.max(0, basePoints - (task.priority === 'Normal' ? 1 : task.priority === 'High' ? 2 : 3));
                }
                return basePoints;
            }
            return 0; // No points for pending tasks
        }

        // Calculate total points for a member
        function calculateMemberPoints(member) {
            let totalPoints = 0;
            (member.tasks || []).forEach(task => {
                totalPoints += calculateTaskPoints(task);
            });
            (member.completedTasks || []).forEach(task => {
                totalPoints += calculateTaskPoints(task);
            });
            return totalPoints;
        }

        // Check if task is overdue
        function isTaskOverdue(task) {
            if (task.due === 'No Deadline') return false;
            try {
                let dueDate;
                const now = new Date();
                if (task.due.includes(' ')) {
                    dueDate = new Date(task.due);
                } else {
                    dueDate = new Date(task.createdAt);
                    if (task.due === '1 hour') dueDate.setHours(dueDate.getHours() + 1);
                    else if (task.due === '3 hours') dueDate.setHours(dueDate.getHours() + 3);
                    else if (task.due === 'Today EOD') dueDate.setHours(23, 59, 59);
                    else if (task.due === 'Tomorrow') dueDate.setDate(dueDate.getDate() + 1);
                    else if (task.due === 'This week') dueDate.setDate(dueDate.getDate() + 7 - dueDate.getDay());
                }
                return dueDate < now;
            } catch (e) {
                console.error('Overdue check error for task:', task, e);
                return false;
            }
        }

        // Calculate task completion timing
        function calculateTaskTiming(due, createdAt, completedAt) {
            if (due === 'No Deadline') return 'On Time';
            try {
                const completed = new Date(completedAt);
                let dueDate;
                const now = new Date(createdAt);
                if (due.includes(' ')) {
                    dueDate = new Date(due);
                } else {
                    dueDate = new Date(now);
                    if (due === '1 hour') dueDate.setHours(dueDate.getHours() + 1);
                    else if (due === '3 hours') dueDate.setHours(dueDate.getHours() + 3);
                    else if (due === 'Today EOD') dueDate.setHours(23, 59, 59);
                    else if (due === 'Tomorrow') dueDate.setDate(dueDate.getDate() + 1);
                    else if (due === 'This week') dueDate.setDate(dueDate.getDate() + 7 - dueDate.getDay());
                }
                const diff = completed - dueDate;
                if (diff < -30 * 60 * 1000) return 'Early'; // More than 30 minutes early
                else if (diff > 30 * 60 * 1000) return 'Late'; // More than 30 minutes late
                return 'On Time';
            } catch (e) {
                console.error('Task timing error:', e);
                return 'Unknown';
            }
        }

        // Render events in sidebar
        function renderEvents() {
            const eventList = document.getElementById('event-list');
            eventList.innerHTML = events.length === 0 ? '<p class="text-gray-600">No events. Create one to start!</p>' : '';
            events.forEach((event, index) => {
                const li = document.createElement('li');
                li.className = 'event-item flex justify-between items-center';
                li.innerHTML = `
                    <span class="flex-1 cursor-pointer" onclick="loadEvent(${index})">${event.name}</span>
                    <button class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600" onclick="deleteEvent(${index})">Delete</button>
                `;
                eventList.appendChild(li);
            });
            console.log('Events rendered:', events);
        }

        // Load selected event
        function loadEvent(index) {
            if (!events[index]) {
                alert('Error: Event not found.');
                console.error('Event not found at index:', index);
                return;
            }
            currentEvent = events[index];
            selectedTeam = null;
            document.getElementById('event-title').textContent = currentEvent.name;
            document.getElementById('no-event-selected').classList.add('hidden');
            document.getElementById('event-details').classList.remove('hidden');
            document.getElementById('selected-team-members').classList.add('hidden');
            renderTeams();
            checkDeadlines();
            updateQuickMembers();
            console.log('Event loaded:', currentEvent.name);
        }

        // Render teams for current event
        function renderTeams() {
            if (!currentEvent) return;
            const teamList = document.getElementById('team-list');
            const quickTeam = document.getElementById('quick-team');
            teamList.innerHTML = currentEvent.teams.length === 0 ? '<p class="text-gray-600">No teams. Add one!</p>' : '';
            quickTeam.innerHTML = '<option value="">Select Team</option>';
            currentEvent.teams.forEach((team, teamIndex) => {
                const li = document.createElement('li');
                li.className = 'team-item flex justify-between items-center';
                li.innerHTML = `
                    <span class="cursor-pointer flex-1" onclick="selectTeam('${team}')">${team}</span>
                    <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 mr-2" onclick="addMember('${team}')">Add Member</button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600" onclick="deleteTeam(${teamIndex})">Delete</button>
                `;
                teamList.appendChild(li);

                const opt = document.createElement('option');
                opt.value = team;
                opt.text = team;
                quickTeam.appendChild(opt);
            });
            console.log('Teams rendered for event:', currentEvent.name);
        }

        // Render leaderboard (for modal)
        function renderLeaderboard() {
            if (!currentEvent) return;
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            let members = [];
            Object.keys(currentEvent.membersByTeam).forEach(team => {
                currentEvent.membersByTeam[team].forEach(member => {
                    members.push({name: member.name, points: calculateMemberPoints(member)});
                });
            });
            members.sort((a, b) => b.points - a.points);
            if (members.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-600">No points earned yet.</p>';
            } else {
                members.forEach((member, index) => {
                    const li = document.createElement('li');
                    li.className = 'member-item';
                    li.innerHTML = `#${index + 1}: ${member.name}`;
                    leaderboardList.appendChild(li);
                });
            }
            console.log('Leaderboard rendered:', members);
        }

        // Select a team and show its members dropdown and list
        window.selectTeam = function(team) {
            selectedTeam = team;
            document.getElementById('selected-team-title').textContent = `Members of ${team}`;
            document.getElementById('selected-team-members').classList.remove('hidden');
            renderTeamMemberDropdown();
            renderSelectedTeamMembers();
            console.log('Team selected:', team);
        };

        // Render dropdown for team members
        function renderTeamMemberDropdown() {
            const dropdown = document.getElementById('team-member-dropdown');
            dropdown.innerHTML = '<option value="">Select Member</option>';
            if (currentEvent && currentEvent.membersByTeam[selectedTeam]) {
                currentEvent.membersByTeam[selectedTeam].forEach(member => {
                    const opt = document.createElement('option');
                    opt.value = member.name;
                    opt.text = member.name;
                    dropdown.appendChild(opt);
                });
            }
        }

        // Open modal from dropdown
        window.openTaskModalFromDropdown = function() {
            const selectedMember = document.getElementById('team-member-dropdown').value;
            if (selectedMember) {
                openTaskModal(selectedMember, selectedTeam);
            } else {
                alert('Please select a member from the dropdown.');
            }
        };

        // Render members of selected team (detailed list)
        function renderSelectedTeamMembers() {
            if (!currentEvent || !selectedTeam) return;
            const selectedMembersList = document.getElementById('selected-members-list');
            selectedMembersList.innerHTML = currentEvent.membersByTeam[selectedTeam].length === 0 ? '<p class="text-gray-600">No members in this team. Add one!</p>' : '';
            currentEvent.membersByTeam[selectedTeam].forEach((member, memberIndex) => {
                if (!member.completedTasks) member.completedTasks = [];
                const taskCount = member.tasks.length;
                const status = taskCount < 3 ? 'Free' : 'Busy';
                const totalPoints = calculateMemberPoints(member);
                const li = document.createElement('li');
                li.className = 'member-item flex flex-col';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${member.name} - <span class="${status === 'Free' ? 'text-green-600' : 'text-red-600'}">${status}</span> - Points: ${totalPoints}</span>
                        <div>
                            <button class="ml-2 bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600" onclick="openTaskModal('${member.name}', '${selectedTeam}')">Assign</button>
                            <button class="ml-2 bg-purple-500 text-white px-2 py-1 rounded text-sm hover:bg-purple-600" onclick="openHistoryModal('${member.name}', '${selectedTeam}')">History</button>
                            <button class="ml-2 bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600" onclick="deleteMember('${selectedTeam}', ${memberIndex})">Delete</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 mt-2">${
                        member.tasks.length > 0 
                            ? member.tasks.map((task, taskIndex) => {
                                const isOverdue = isTaskOverdue(task);
                                return `
                                    <div class="task-item flex justify-between items-center ${isOverdue ? 'overdue-task' : ''}">
                                        ${task.description} [${task.category}, ${task.priority}, ${task.due}]<br><span class="text-xs text-gray-400">${task.details || 'No description'}</span>
                                        <div class="button-group">
                                            <button class="bg-gray-500 text-white px-2 py-1 rounded text-sm hover:bg-gray-600">Actions ‚ñº</button>
                                            <div class="dropdown-content">
                                                <button onclick="editTask('${member.name}', '${selectedTeam}', ${taskIndex}, 'Pending')">Edit</button>
                                                <button onclick="completeTask('${selectedTeam}', '${member.name}', ${taskIndex})">Complete</button>
                                                <button onclick="deleteTask('${member.name}', '${selectedTeam}', ${taskIndex}, 'Pending')">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                            : 'No tasks assigned'
                    }</div>
                `;
                selectedMembersList.appendChild(li);
            });
            console.log('Members rendered for team:', selectedTeam);
        }

        // Render pending tasks (for modal)
        function renderPendingTasksModal() {
            if (!currentEvent) return;
            const pendingList = document.getElementById('pending-task-list');
            const filterCategory = document.getElementById('pending-task-filter').value;
            pendingList.innerHTML = '';
            let hasPending = false;
            Object.keys(currentEvent.membersByTeam).forEach(team => {
                currentEvent.membersByTeam[team].forEach(member => {
                    if (!member.completedTasks) member.completedTasks = [];
                    const filteredTasks = filterCategory ? member.tasks.filter(task => task.category === filterCategory) : member.tasks;
                    if (filteredTasks.length > 0) {
                        hasPending = true;
                        const totalPoints = calculateMemberPoints(member);
                        const li = document.createElement('li');
                        li.className = 'member-item flex flex-col';
                        li.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span>${member.name} (${team}) - Tasks Pending: ${filteredTasks.length} - Points: ${totalPoints}</span>
                                <div>
                                    <button class="ml-2 bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600" onclick="openTaskModal('${member.name}', '${team}')">Assign More</button>
                                    <button class="ml-2 bg-purple-500 text-white px-2 py-1 rounded text-sm hover:bg-purple-600" onclick="openHistoryModal('${member.name}', '${team}')">History</button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">${
                                filteredTasks.map((task, taskIndex) => {
                                    const isOverdue = isTaskOverdue(task);
                                    return `
                                        <div class="task-item flex justify-between items-center ${isOverdue ? 'overdue-task' : ''}">
                                            ${task.description} [${task.category}, ${task.priority}, ${task.due}]<br><span class="text-xs text-gray-400">${task.details || 'No description'}</span>
                                            <div class="button-group">
                                                <button class="bg-gray-500 text-white px-2 py-1 rounded text-sm hover:bg-gray-600">Actions ‚ñº</button>
                                                <div class="dropdown-content">
                                                    <button onclick="editTask('${member.name}', '${team}', ${taskIndex}, 'Pending')">Edit</button>
                                                    <button onclick="completeTask('${team}', '${member.name}', ${taskIndex})">Complete</button>
                                                    <button onclick="deleteTask('${member.name}', '${team}', ${taskIndex}, 'Pending')">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            }</div>
                        `;
                        pendingList.appendChild(li);
                    }
                });
            });
            if (!hasPending) {
                pendingList.innerHTML = '<p class="text-gray-600">No pending work. Assign some tasks!</p>';
            }
            console.log('Pending tasks rendered, filter:', filterCategory);
        }

        // Check deadlines for overdue tasks
        function checkDeadlines() {
            if (!currentEvent) return 'No event selected.';
            const now = new Date();
            let overdue = [];
            Object.keys(currentEvent.membersByTeam).forEach(team => {
                currentEvent.membersByTeam[team].forEach(member => {
                    member.tasks.forEach((task, taskIndex) => {
                        if (task.due !== 'No Deadline') {
                            let dueDate;
                            try {
                                if (task.due.includes(' ')) {
                                    dueDate = new Date(task.due);
                                } else {
                                    dueDate = new Date(task.createdAt);
                                    if (task.due === '1 hour') dueDate.setHours(dueDate.getHours() + 1);
                                    else if (task.due === '3 hours') dueDate.setHours(dueDate.getHours() + 3);
                                    else if (task.due === 'Today EOD') dueDate.setHours(23, 59, 59);
                                    else if (task.due === 'Tomorrow') dueDate.setDate(dueDate.getDate() + 1);
                                    else if (task.due === 'This week') dueDate.setDate(dueDate.getDate() + 7 - dueDate.getDay());
                                }
                                if (dueDate < now) {
                                    overdue.push(`${task.description} for ${member.name} (${team}) - Due: ${task.due}`);
                                }
                            } catch (e) {
                                console.error('Deadline check error for task:', task, e);
                            }
                        }
                    });
                });
            });
            const notification = document.getElementById('overdue-notification');
            const overdueTasks = document.getElementById('overdue-tasks');
            if (overdue.length > 0) {
                overdueTasks.textContent = overdue.join(', ');
                notification.classList.remove('hidden');
            } else {
                notification.classList.add('hidden');
            }
            console.log('Deadlines checked:', overdue);
            return overdue.length > 0 ? `Overdue tasks: ${overdue.join(', ')}` : 'No overdue tasks.';
        }

        // Open quick task modal
        window.openQuickTaskModal = function() {
            if (!currentEvent) {
                alert('Please select an event first.');
                return;
            }
            try {
                document.getElementById('quick-task').value = '';
                document.getElementById('quick-description').value = '';
                document.getElementById('quick-category').value = 'General';
                document.getElementById('quick-priority').value = 'Normal';
                document.getElementById('quick-due').value = '1 hour';
                document.getElementById('quick-custom-due-fields').style.display = 'none';
                document.getElementById('quick-custom-date').value = '';
                document.getElementById('quick-custom-time').value = '';
                updateQuickMembers();
                document.getElementById('quick-task-modal').showModal();
                console.log('Quick task modal opened');
            } catch (e) {
                alert('Error opening quick task modal. Please check the console for details.');
                console.error('Modal open error:', e);
            }
        };

        // Close quick task modal
        window.closeQuickTaskModal = function() {
            try {
                document.getElementById('quick-task-modal').close();
                console.log('Quick task modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Toggle custom due in quick modal
        window.toggleQuickCustomDue = function() {
            const dueSelect = document.getElementById('quick-due');
            const customFields = document.getElementById('quick-custom-due-fields');
            customFields.style.display = dueSelect.value === 'Custom' ? 'block' : 'none';
        };

        // Open pending tasks modal
        window.openPendingModal = function() {
            if (!currentEvent) {
                alert('Please select an event first.');
                return;
            }
            try {
                document.getElementById('pending-task-filter').value = '';
                renderPendingTasksModal();
                document.getElementById('pending-modal').showModal();
                console.log('Pending tasks modal opened');
            } catch (e) {
                alert('Error opening pending tasks modal. Please check the console for details.');
                console.error('Modal open error:', e);
            }
        };

        // Close pending tasks modal
        window.closePendingModal = function() {
            try {
                document.getElementById('pending-modal').close();
                console.log('Pending tasks modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Open leaderboard modal
        window.openLeaderboardModal = function() {
            if (!currentEvent) {
                alert('Please select an event first.');
                return;
            }
            try {
                renderLeaderboard();
                document.getElementById('leaderboard-modal').showModal();
                console.log('Leaderboard modal opened');
            } catch (e) {
                alert('Error opening leaderboard modal. Please check the console for details.');
                console.error('Modal open error:', e);
            }
        };

        // Close leaderboard modal
        window.closeLeaderboardModal = function() {
            try {
                document.getElementById('leaderboard-modal').close();
                console.log('Leaderboard modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Open history modal
        window.openHistoryModal = function(memberName, team) {
            if (!currentEvent || !currentEvent.membersByTeam[team]) {
                alert('Error: Team or event not found.');
                console.error('Team not found:', team);
                return;
            }
            const member = currentEvent.membersByTeam[team].find(m => m.name === memberName);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', memberName);
                return;
            }
            if (!member.completedTasks) member.completedTasks = [];
            document.getElementById('history-member-name').textContent = memberName;
            document.getElementById('history-member-points').textContent = calculateMemberPoints(member);
            const historyList = document.getElementById('history-task-list');
            historyList.innerHTML = '';
            const allTasks = [
                ...member.tasks.map((task, index) => ({...task, status: 'Pending', index})),
                ...member.completedTasks.map((task, index) => ({...task, status: 'Completed', index}))
            ];
            if (allTasks.length === 0) {
                historyList.innerHTML = '<p class="text-gray-600">No task history.</p>';
            } else {
                allTasks.forEach(task => {
                    const timing = task.status === 'Completed' ? calculateTaskTiming(task.due, task.createdAt, task.completedAt) : '';
                    const timingStyle = timing === 'Early' ? 'text-green-600' : timing === 'Late' ? 'text-red-600' : 'text-blue-600';
                    const li = document.createElement('li');
                    li.className = `task-item ${task.status === 'Pending' && isTaskOverdue(task) ? 'overdue-task' : ''}`;
                    li.innerHTML = `
                        ${task.description} [${task.category}, ${task.priority}, ${task.due}] - 
                        <span class="${task.status === 'Pending' ? 'text-yellow-600' : 'text-gray-600'}">${task.status}</span>
                        ${task.status === 'Completed' ? `- <span class="${timingStyle}">${timing}</span> - Points: ${calculateTaskPoints(task)}` : ''}
                        ${task.remarks ? `<br><span class="text-xs text-gray-400">Remarks: ${task.remarks}</span>` : ''}
                        <br><span class="text-xs text-gray-400">${task.details || 'No description'}</span>
                        <br><span class="text-xs text-gray-400">Assigned: ${formatTimestamp(task.createdAt)}</span>
                        <div class="button-group">
                            <button class="bg-gray-500 text-white px-2 py-1 rounded text-sm hover:bg-gray-600">Actions ‚ñº</button>
                            <div class="dropdown-content">
                                <button onclick="editTask('${memberName}', '${team}', ${task.index}, '${task.status}')">Edit</button>
                                ${task.status === 'Pending' ? `<button onclick="completeTask('${team}', '${memberName}', ${task.index})">Complete</button>` : ''}
                                <button onclick="deleteTask('${memberName}', '${team}', ${task.index}, '${task.status}')">Delete</button>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(li);
                });
            }
            try {
                document.getElementById('history-modal').showModal();
                console.log('History modal opened for:', memberName);
            } catch (e) {
                alert('Error opening history modal.');
                console.error('Modal open error:', e);
            }
        };

        // Close history modal
        window.closeHistoryModal = function() {
            try {
                document.getElementById('history-modal').close();
                console.log('History modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Edit task
        window.editTask = function(memberName, team, taskIndex, status) {
            if (!currentEvent || !currentEvent.membersByTeam[team]) {
                alert('Error: Team not found.');
                console.error('Team not found:', team);
                return;
            }
            const member = currentEvent.membersByTeam[team].find(m => m.name === memberName);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', memberName);
                return;
            }
            const taskList = status === 'Pending' ? member.tasks : member.completedTasks;
            const task = taskList[taskIndex];
            if (!task) {
                alert('Error: Task not found.');
                console.error('Task not found at index:', taskIndex);
                return;
            }
            currentEditMember = memberName;
            currentEditTeam = team;
            currentEditTaskIndex = taskIndex;
            currentEditTaskStatus = status;
            document.getElementById('edit-member-name').textContent = memberName;
            document.getElementById('edit-task').value = task.description;
            document.getElementById('edit-description').value = task.details || '';
            document.getElementById('edit-category').value = task.category || 'General';
            document.getElementById('edit-priority').value = task.priority;
            document.getElementById('edit-due').value = task.due.includes(' ') ? 'Custom' : task.due;
            document.getElementById('edit-remarks').value = task.remarks || '';
            document.getElementById('edit-custom-due-fields').style.display = task.due.includes(' ') ? 'block' : 'none';
            if (task.due.includes(' ')) {
                const [date, time] = task.due.split(' ');
                document.getElementById('edit-custom-date').value = date;
                document.getElementById('edit-custom-time').value = time;
            } else {
                document.getElementById('edit-custom-date').value = '';
                document.getElementById('edit-custom-time').value = '';
            }
            try {
                document.getElementById('edit-task-modal').showModal();
                console.log('Edit task modal opened for:', memberName, 'task:', task.description);
            } catch (e) {
                alert('Error opening edit task modal.');
                console.error('Modal open error:', e);
            }
        };

        // Close edit task modal
        window.closeEditTaskModal = function() {
            try {
                document.getElementById('edit-task-modal').close();
                console.log('Edit task modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Toggle custom due in edit modal
        window.toggleEditCustomDue = function() {
            const dueSelect = document.getElementById('edit-due');
            const customFields = document.getElementById('edit-custom-due-fields');
            customFields.style.display = dueSelect.value === 'Custom' ? 'block' : 'none';
        };

        // Save edited task
        document.getElementById('edit-save').addEventListener('click', () => {
            const taskDesc = document.getElementById('edit-task').value.trim();
            const taskDetails = document.getElementById('edit-description').value.trim();
            const category = document.getElementById('edit-category').value;
            const priority = document.getElementById('edit-priority').value;
            const remarks = document.getElementById('edit-remarks').value.trim();
            let due = document.getElementById('edit-due').value;
            if (due === 'Custom') {
                const customDate = document.getElementById('edit-custom-date').value;
                const customTime = document.getElementById('edit-custom-time').value;
                if (!customDate || !customTime) {
                    alert('Please select both date and time for custom due.');
                    return;
                }
                due = `${customDate} ${customTime}`;
            }
            if (!taskDesc) {
                alert('Please enter a task name.');
                return;
            }
            if (!currentEvent || !currentEvent.membersByTeam[currentEditTeam]) {
                alert('Error: Team not found.');
                console.error('Team not found:', currentEditTeam);
                return;
            }
            const member = currentEvent.membersByTeam[currentEditTeam].find(m => m.name === currentEditMember);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', currentEditMember);
                return;
            }
            const taskList = currentEditTaskStatus === 'Pending' ? member.tasks : member.completedTasks;
            taskList[currentEditTaskIndex] = {
                description: taskDesc,
                details: taskDetails,
                category: category,
                priority: priority,
                due: due,
                remarks: remarks,
                createdAt: taskList[currentEditTaskIndex].createdAt,
                completedAt: taskList[currentEditTaskIndex].completedAt
            };
            try {
                saveData();
                if (selectedTeam === currentEditTeam) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                alert(`Task "${taskDesc}" updated for ${currentEditMember}.`);
                closeEditTaskModal();
                if (document.getElementById('history-modal').open) {
                    openHistoryModal(currentEditMember, currentEditTeam);
                }
            } catch (e) {
                alert('Error updating task.');
                console.error('Task update error:', e);
            }
        });

        // Delete task
        window.deleteTask = function(memberName, team, taskIndex, status) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            if (!currentEvent || !currentEvent.membersByTeam[team]) {
                alert('Error: Team not found.');
                console.error('Team not found:', team);
                return;
            }
            const member = currentEvent.membersByTeam[team].find(m => m.name === memberName);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', memberName);
                return;
            }
            const taskList = status === 'Pending' ? member.tasks : member.completedTasks;
            const task = taskList[taskIndex];
            if (!task) {
                alert('Error: Task not found.');
                console.error('Task not found at index:', taskIndex);
                return;
            }
            taskList.splice(taskIndex, 1);
            try {
                saveData();
                if (selectedTeam === team) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                alert(`Task "${task.description}" deleted for ${memberName}.`);
                if (document.getElementById('history-modal').open) {
                    openHistoryModal(memberName, team);
                }
            } catch (e) {
                alert('Error deleting task.');
                console.error('Task deletion error:', e);
            }
        };

        // Complete task
        window.completeTask = function(team, memberName, taskIndex) {
            if (!currentEvent || !currentEvent.membersByTeam[team]) {
                alert('Error: Team not found.');
                console.error('Team not found:', team);
                return;
            }
            const member = currentEvent.membersByTeam[team].find(m => m.name === memberName);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', memberName);
                return;
            }
            const task = member.tasks[taskIndex];
            if (!task) {
                alert('Error: Task not found.');
                console.error('Task not found at index:', taskIndex);
                return;
            }
            const remarks = prompt('Enter remarks for task completion (optional):', '');
            if (!member.completedTasks) member.completedTasks = [];
            task.completedAt = new Date().toISOString();
            task.remarks = remarks || '';
            task.status = 'Completed';
            member.completedTasks.push(task);
            member.tasks.splice(taskIndex, 1);
            try {
                saveData();
                if (selectedTeam === team) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                alert(`Task "${task.description}" completed for ${memberName}.`);
                console.log('Task completed:', task.description, 'for', memberName, 'Remarks:', remarks);
            } catch (e) {
                alert('Error completing task.');
                console.error('Task completion error:', e);
            }
        };

        // Update quick members based on selected team
        window.updateQuickMembers = function() {
            const selectedTeam = document.getElementById('quick-team').value;
            const quickMember = document.getElementById('quick-member');
            quickMember.innerHTML = '<option value="">Select Member</option>';
            if (currentEvent) {
                Object.keys(currentEvent.membersByTeam).forEach(team => {
                    if (selectedTeam === '' || selectedTeam === team) {
                        currentEvent.membersByTeam[team].forEach(member => {
                            const opt = document.createElement('option');
                            opt.value = `${member.name}|${team}`;
                            opt.text = `${member.name} (${team})`;
                            quickMember.appendChild(opt);
                        });
                    }
                });
            }
            console.log('Quick members updated for team:', selectedTeam);
        };

        // Add new event
        document.getElementById('new-event').addEventListener('click', () => {
            const eventName = prompt('Enter new event name:');
            if (eventName) {
                const newEvent = {
                    name: eventName,
                    teams: [],
                    membersByTeam: {}
                };
                events.push(newEvent);
                saveData();
                renderEvents();
                loadEvent(events.length - 1);
            }
        });

        // Delete event
        window.deleteEvent = function(index) {
            if (confirm('Are you sure you want to delete this entire event?')) {
                events.splice(index, 1);
                saveData();
                renderEvents();
                if (events.length > 0) {
                    loadEvent(0);
                } else {
                    currentEvent = null;
                    document.getElementById('event-details').classList.add('hidden');
                    document.getElementById('no-event-selected').classList.remove('hidden');
                }
                console.log('Event deleted at index:', index);
            }
        };

        // Add new team to current event
        document.getElementById('new-team').addEventListener('click', () => {
            if (!currentEvent) {
                alert('Please select an event first.');
                return;
            }
            const teamName = prompt('Enter new team name:');
            if (teamName && !currentEvent.teams.includes(teamName)) {
                currentEvent.teams.push(teamName);
                currentEvent.membersByTeam[teamName] = [];
                saveData();
                renderTeams();
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                updateQuickMembers();
                console.log('Team added:', teamName);
            }
        });

        // Delete team
        window.deleteTeam = function(teamIndex) {
            if (confirm('Are you sure you want to delete this entire team and all its members?')) {
                const teamName = currentEvent.teams[teamIndex];
                currentEvent.teams.splice(teamIndex, 1);
                delete currentEvent.membersByTeam[teamName];
                saveData();
                renderTeams();
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                updateQuickMembers();
                if (selectedTeam === teamName) {
                    selectedTeam = null;
                    document.getElementById('selected-team-members').classList.add('hidden');
                }
                console.log('Team deleted:', teamName);
            }
        };

        // Add member to team
        window.addMember = function(team) {
            const memberName = prompt(`Enter member name for ${team}:`);
            if (memberName) {
                currentEvent.membersByTeam[team].push({name: memberName, tasks: [], completedTasks: []});
                saveData();
                if (selectedTeam === team) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                updateQuickMembers();
                console.log('Member added:', memberName, 'to team:', team);
            }
        };

        // Delete member
        window.deleteMember = function(team, memberIndex) {
            if (confirm('Are you sure you want to delete this member?')) {
                currentEvent.membersByTeam[team].splice(memberIndex, 1);
                saveData();
                if (selectedTeam === team) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                updateQuickMembers();
                console.log('Member deleted from team:', team, 'index:', memberIndex);
            }
        };

        // Open task modal
        window.openTaskModal = function(memberName, team) {
            if (!currentEvent || !currentEvent.membersByTeam[team]) {
                alert('Error: Team not found.');
                console.error('Team not found:', team);
                return;
            }
            currentAssignMember = memberName;
            currentAssignTeam = team;
            document.getElementById('modal-member-name').textContent = memberName;
            document.getElementById('modal-task').value = '';
            document.getElementById('modal-description').value = '';
            document.getElementById('modal-category').value = 'General';
            document.getElementById('modal-priority').value = 'Normal';
            document.getElementById('modal-due').value = '1 hour';
            document.getElementById('modal-custom-due-fields').style.display = 'none';
            try {
                document.getElementById('task-modal').showModal();
                console.log('Task modal opened for:', memberName);
            } catch (e) {
                alert('Error opening task modal.');
                console.error('Modal open error:', e);
            }
        };

        // Close task modal
        window.closeTaskModal = function() {
            try {
                document.getElementById('task-modal').close();
                console.log('Task modal closed');
            } catch (e) {
                console.error('Modal close error:', e);
            }
        };

        // Toggle custom due in modal
        window.toggleModalCustomDue = function() {
            const dueSelect = document.getElementById('modal-due');
            const customFields = document.getElementById('modal-custom-due-fields');
            customFields.style.display = dueSelect.value === 'Custom' ? 'block' : 'none';
        };

        // Assign task from modal
        document.getElementById('modal-assign').addEventListener('click', () => {
            const taskDesc = document.getElementById('modal-task').value.trim();
            const taskDetails = document.getElementById('modal-description').value.trim();
            const category = document.getElementById('modal-category').value;
            const priority = document.getElementById('modal-priority').value;
            let due = document.getElementById('modal-due').value;
            if (due === 'Custom') {
                const customDate = document.getElementById('modal-custom-date').value;
                const customTime = document.getElementById('modal-custom-time').value;
                if (!customDate || !customTime) {
                    alert('Please select both date and time for custom due.');
                    return;
                }
                due = `${customDate} ${customTime}`;
            }
            if (!taskDesc) {
                alert('Please enter a task name.');
                return;
            }
            if (!currentEvent || !currentEvent.membersByTeam[currentAssignTeam]) {
                alert('Error: Team not found.');
                console.error('Team not found:', currentAssignTeam);
                return;
            }
            const member = currentEvent.membersByTeam[currentAssignTeam].find(m => m.name === currentAssignMember);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', currentAssignMember);
                return;
            }
            if (!member.completedTasks) member.completedTasks = [];
            member.tasks.push({
                description: taskDesc,
                details: taskDetails,
                category: category,
                priority: priority,
                due: due,
                createdAt: new Date().toISOString()
            });
            try {
                saveData();
                if (selectedTeam === currentAssignTeam) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                alert(`Task "${taskDesc}" assigned to ${currentAssignMember}.`);
                closeTaskModal();
            } catch (e) {
                alert('Error assigning task.');
                console.error('Task assignment error:', e);
            }
        });

        // Assign task from quick modal
        document.getElementById('quick-assign').addEventListener('click', () => {
            if (!currentEvent) {
                alert('Please select an event first.');
                return;
            }
            const team = document.getElementById('quick-team').value;
            const memberInfo = document.getElementById('quick-member').value;
            if (!memberInfo) {
                alert('Please select a member.');
                return;
            }
            const [memberName, memberTeam] = memberInfo.split('|');
            const taskDesc = document.getElementById('quick-task').value.trim();
            const taskDetails = document.getElementById('quick-description').value.trim();
            const category = document.getElementById('quick-category').value;
            const priority = document.getElementById('quick-priority').value;
            let due = document.getElementById('quick-due').value;
            if (due === 'Custom') {
                const customDate = document.getElementById('quick-custom-date').value;
                const customTime = document.getElementById('quick-custom-time').value;
                if (!customDate || !customTime) {
                    alert('Please select both date and time for custom due.');
                    return;
                }
                due = `${customDate} ${customTime}`;
            }
            if (!taskDesc) {
                alert('Please enter a task name.');
                return;
            }
            if (!team || !memberName) {
                alert('Please select both a team and a member.');
                return;
            }
            if (!currentEvent.membersByTeam[memberTeam]) {
                alert('Error: Team not found.');
                console.error('Team not found:', memberTeam);
                return;
            }
            const member = currentEvent.membersByTeam[memberTeam].find(m => m.name === memberName);
            if (!member) {
                alert('Error: Member not found.');
                console.error('Member not found:', memberName);
                return;
            }
            if (!member.completedTasks) member.completedTasks = [];
            member.tasks.push({
                description: taskDesc,
                details: taskDetails,
                category: category,
                priority: priority,
                due: due,
                createdAt: new Date().toISOString()
            });
            try {
                saveData();
                if (selectedTeam === memberTeam) {
                    renderTeamMemberDropdown();
                    renderSelectedTeamMembers();
                }
                renderPendingTasksModal();
                renderLeaderboard();
                checkDeadlines();
                alert(`Task "${taskDesc}" assigned to ${memberName}.`);
                closeQuickTaskModal();
            } catch (e) {
                alert('Error assigning task.');
                console.error('Quick task assignment error:', e);
            }
        });
       
        // Login function
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        // Register function
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                // Create user profile
                await createUserProfile(result.user.uid, email);
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                alert('Registration error: ' + error.message);
            }
        }

        

        // ================= AUTH STATE LISTENER =================
        // This runs automatically when page loads to check login status
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User signed in
                currentUserId = user.uid;
                document.getElementById('logged-out').classList.add('hidden');
                document.getElementById('logged-in').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                
                // Load user profile and events
                await loadUserData(user.uid);
                await loadUserEvents(user.uid);
                
                console.log('User logged in:', user.email);
            } else {
                // User signed out
                currentUserId = null;
                currentUserProfile = null;
                document.getElementById('logged-in').classList.add('hidden');
                document.getElementById('logged-out').classList.remove('hidden');
                
                // Load from local storage as fallback
                events = JSON.parse(localStorage.getItem(STORAGE_EVENTS)) || [];
                renderEvents();
                
                console.log('User logged out');
            }
        });
        
        // ================= END AUTH STATE LISTENER =================

        // Create user profile
        async function createUserProfile(uid, email) {
            try {
                await db.ref('users/' + uid).set({
                    email: email,
                    displayName: '',
                    phone: '',
                    role: 'Member',
                    bio: '',
                    createdAt: new Date().toISOString(),
                    totalPoints: 0
                });
                console.log('User profile created');
            } catch (error) {
                console.error('Error creating profile:', error);
            }
        }

        // Load user profile data
        async function loadUserData(uid) {
            try {
                const snapshot = await db.ref('users/' + uid).once('value');
                const userData = snapshot.val();
                if (userData) {
                    currentUserProfile = userData;
                    console.log('User profile loaded:', currentUserProfile);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load user's events from Realtime Database
        async function loadUserEvents(uid) {
            try {
                const snapshot = await db.ref('users/' + uid + '/events').once('value');
                const firebaseEvents = snapshot.val();
                
                if (firebaseEvents) {
                    events = firebaseEvents;
                } else {
                    // If no events in Firebase, check localStorage
                    events = JSON.parse(localStorage.getItem(STORAGE_EVENTS)) || [];
                }
                
                renderEvents();
                if (events.length > 0) {
                    loadEvent(0);
                }
                console.log('User events loaded:', events.length);
            } catch (error) {
                console.error('Error loading events:', error);
                // Fallback to localStorage
                events = JSON.parse(localStorage.getItem(STORAGE_EVENTS)) || [];
                renderEvents();
            }
        }

        // Profile modal functions
        function openProfile() {
            if (currentUserProfile) {
                document.getElementById('profile-name').value = currentUserProfile.displayName || '';
                document.getElementById('profile-phone').value = currentUserProfile.phone || '';
                document.getElementById('profile-role').value = currentUserProfile.role || 'Member';
                document.getElementById('profile-bio').value = currentUserProfile.bio || '';
            }
            document.getElementById('profile-modal').showModal();
        }

        function closeProfile() {
            document.getElementById('profile-modal').close();
        }

        async function saveProfile() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please login to save profile');
                return;
            }

            try {
                await db.ref('users/' + user.uid).update({
                    displayName: document.getElementById('profile-name').value,
                    phone: document.getElementById('profile-phone').value,
                    role: document.getElementById('profile-role').value,
                    bio: document.getElementById('profile-bio').value,
                    updatedAt: new Date().toISOString()
                });
                
                alert('Profile updated successfully!');
                closeProfile();
                await loadUserData(user.uid);
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        }
        
        // ================= END FIREBASE FUNCTIONS =================
        // AI toggle
        document.getElementById('ai-toggle').addEventListener('click', () => {
            document.getElementById('ai-chat').classList.toggle('active');
            console.log('AI chat toggled');
        });

        // AI functions
        document.getElementById('send-ai').addEventListener('click', () => {
            const query = document.getElementById('ask-ai').value.toLowerCase().trim();
            if (!query) {
                document.getElementById('ai-suggestion').textContent = 'Please enter a query.';
                return;
            }
            let suggestion = 'Simulated response: ';
            if (query.includes('suggest') || query.includes('assign')) {
                suggestion += suggestAssignments();
            } else if (query.includes('deadline') || query.includes('complete')) {
                suggestion += checkDeadlines();
            } else if (query.includes('history') || query.includes('performance') || query.includes('points')) {
                suggestion += viewMemberPerformance();
            } else {
                suggestion += 'Your query was processed! Try asking about assignments, deadlines, or performance.';
            }
            document.getElementById('ai-suggestion').textContent = suggestion;
            console.log('AI query processed:', query);
        });

        document.getElementById('suggest-assignments').addEventListener('click', () => {
            document.getElementById('ai-suggestion').textContent = suggestAssignments();
        });

        document.getElementById('check-deadlines').addEventListener('click', () => {
            document.getElementById('ai-suggestion').textContent = checkDeadlines();
        });

        document.getElementById('view-history').addEventListener('click', () => {
            document.getElementById('ai-suggestion').textContent = viewMemberPerformance();
        });

        function suggestAssignments() {
            if (!currentEvent) return 'No event selected.';
            let freeMembers = [];
            Object.keys(currentEvent.membersByTeam).forEach(team => {
                currentEvent.membersByTeam[team].forEach(member => {
                    if (!member.completedTasks) member.completedTasks = [];
                    if (member.tasks.length < 3) {
                        freeMembers.push(`${member.name} (${team}) - Points: ${calculateMemberPoints(member)}`);
                    }
                });
            });
            return freeMembers.length > 0 ? `Suggest assigning to free members: ${freeMembers.join(', ')}` : 'All members are busy.';
        }

        function viewMemberPerformance() {
            if (!currentEvent) return 'No event selected.';
            let topMembers = [];
            Object.keys(currentEvent.membersByTeam).forEach(team => {
                currentEvent.membersByTeam[team].forEach(member => {
                    if (!member.completedTasks) member.completedTasks = [];
                    const points = calculateMemberPoints(member);
                    if (points > 0) {
                        topMembers.push({name: `${member.name} (${team})`, points: points});
                    }
                });
            });
            topMembers.sort((a, b) => b.points - a.points);
            return topMembers.length > 0 
                ? `Top performers: ${topMembers.map(m => `${m.name}: ${m.points} points`).join(', ')}`
                : 'No points earned yet. Complete some tasks!';
        }

                // Initialize data
        async function initializeData() {
            events.forEach(event => {
                if (!event.membersByTeam) event.membersByTeam = {};
                Object.keys(event.membersByTeam).forEach(team => {
                    event.membersByTeam[team].forEach(member => {
                        if (!member.tasks) member.tasks = [];
                        if (!member.completedTasks) member.completedTasks = [];
                    });
                });
            });
            await saveData();
            console.log('Data initialized');
        }

        // Event listeners for modal buttons
        document.getElementById('open-quick-task-modal').addEventListener('click', openQuickTaskModal);
        document.getElementById('open-pending-modal').addEventListener('click', openPendingModal);
        document.getElementById('open-leaderboard-modal').addEventListener('click', openLeaderboardModal);

        // Initial render
        try {
            initializeData();
            renderEvents();
            if (events.length === 0) {
                document.getElementById('event-details').classList.add('hidden');
                document.getElementById('no-event-selected').classList.remove('hidden');
            } else {
                loadEvent(0);
            }
            console.log('App initialized successfully');
        } catch (e) {
            alert('Error initializing app. Please check the console.');
            console.error('Initialization error:', e);
        }
    </script>
</body>
</html>